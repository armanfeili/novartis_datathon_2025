# =============================================================================
# CNN-LSTM Model Configuration - Novartis Datathon 2025
# =============================================================================
# Deep learning model combining CNN for local feature extraction with LSTM
# for temporal dependencies. Reference: Li et al. (2024) CNN-LSTM for drug
# sales prediction.
#
# Usage:
#   - Single run: Set sweep.enabled=false, use params directly
#   - Named config: Set active_config_id to use a preset from sweep_configs
#   - Sweep mode: Set sweep.enabled=true to iterate over all sweep_configs
#   - GPU mode: Set device='cuda' (auto-configured in notebook)
#
# CLI Examples:
#   python -m src.train --scenario 1 --model cnn_lstm
#   python -m src.train --scenario 1 --model cnn_lstm --config-id bidirectional
#   python -m src.train --scenario 1 --model cnn_lstm --sweep
# =============================================================================

model:
  name: "cnn_lstm"
  framework: "pytorch"
  task: "regression"
  priority: 4  # Lower priority - experimental deep learning

# =============================================================================
# ACTIVE CONFIGURATION ID
# =============================================================================
# Set this to use a specific named configuration from sweep_configs.
# Set to null or "default" to use the base params below.
active_config_id: null

# =============================================================================
# GPU CONFIGURATION
# =============================================================================
gpu:
  enabled: false  # Set true for GPU training (auto-set by notebook)
  device_id: 0

# =============================================================================
# SWEEP CONFIGURATION
# =============================================================================
# Selection criterion: official_metric (PE), NOT RMSE
# K-fold CV: Use n_folds for robust hyperparameter selection
#
# Modes:
#   - "configs": Iterate over sweep_configs list (explicit configs)
#   - "grid": Expand sweep.grid into Cartesian product of all combinations
sweep:
  enabled: false
  mode: "configs"  # "configs" or "grid"
  selection_metric: "official_metric"  # PRIMARY: Use official PE metric
  n_folds: 3  # K-fold CV for robustness
  
  # Grid mode: Expand all combinations of these values
  grid:
    lstm_hidden_dim: [32, 64, 128]
    learning_rate: [0.001, 0.0005, 0.0001]
    dropout: [0.1, 0.2, 0.3]

# =============================================================================
# NAMED SWEEP CONFIGURATIONS (explicit config list)
# =============================================================================
# Each config has: id, description (optional), and param overrides.
# Use with --config-id <id> or --sweep to iterate all.
sweep_configs:
  - id: "default"
    description: "Default balanced configuration"
    params:
      lstm_hidden_dim: 64
      learning_rate: 0.001
      dropout: 0.2

  - id: "small"
    description: "Smaller model for faster training"
    params:
      cnn_channels: [16, 32]
      lstm_hidden_dim: 32
      lstm_num_layers: 1
      learning_rate: 0.001
      dropout: 0.1

  - id: "large"
    description: "Larger model for complex patterns"
    params:
      cnn_channels: [64, 128]
      lstm_hidden_dim: 128
      lstm_num_layers: 3
      learning_rate: 0.0005
      dropout: 0.3

  - id: "bidirectional"
    description: "Bidirectional LSTM for better context"
    params:
      lstm_hidden_dim: 64
      lstm_bidirectional: true
      learning_rate: 0.001
      dropout: 0.2

  - id: "attention_heavy"
    description: "Focus on attention mechanism"
    params:
      lstm_hidden_dim: 64
      attention_enabled: true
      attention_dim: 64
      learning_rate: 0.0005
      dropout: 0.2

  - id: "s1_best"
    description: "Best configuration for Scenario 1"
    params:
      lstm_hidden_dim: 64
      learning_rate: 0.001
      dropout: 0.2

  - id: "s2_best"
    description: "Best configuration for Scenario 2"
    params:
      lstm_hidden_dim: 64
      learning_rate: 0.0005
      dropout: 0.2

# =============================================================================
# MODEL HYPERPARAMETERS (Base Configuration)
# =============================================================================
# These are the default parameters used when active_config_id is null.
# Named configs in sweep_configs override specific values.
params:
  # CNN configuration
  cnn_channels: [32, 64]
  cnn_kernel_sizes: [3, 3]
  cnn_pool_sizes: [2, 2]
  cnn_dropout: 0.2
  
  # LSTM configuration
  lstm_hidden_dim: 64
  lstm_num_layers: 2
  lstm_dropout: 0.2
  lstm_bidirectional: false
  
  # Attention configuration
  attention_enabled: true
  attention_dim: 32
  
  # Feature dimensions
  input_dim: 32
  static_dim: 8
  
  # Fully connected layers
  fc_hidden_dims: [64, 32]
  
  # Output configuration
  forecast_horizon: 1
  output_dim: 1
  
  # Sequence configuration
  lookback_window: 12

# =============================================================================
# TRAINING SETTINGS
# =============================================================================
training:
  learning_rate: 0.001
  weight_decay: 0.00001
  batch_size: 32
  max_epochs: 100
  early_stopping_patience: 10
  use_one_cycle: true  # Use OneCycleLR scheduler
  gradient_clip: 1.0
  label_smoothing: 0.0
  use_sample_weights: true
  device: "auto"  # 'auto', 'cpu', or 'cuda'

# =============================================================================
# FEATURE CONFIGURATION
# =============================================================================
features:
  # Time-varying features for CNN-LSTM input
  time_varying:
    - n_generics
    - avg_generic_price
    - min_generic_price
    - generic_penetration
    - months_since_loe
    - market_hhi
    - brand_price
    - volume_lag_1
    - volume_lag_3
    - volume_lag_6
    - volume_ma_3
    - volume_ma_6
    - volume_trend
    - volume_volatility
    - price_ratio
    - market_concentration
  
  # Static features
  static:
    - therapeutic_area_encoded
    - route_encoded
    - dosage_form_encoded
    - brand_tier

# =============================================================================
# DATA AUGMENTATION
# =============================================================================
augmentation:
  enabled: false
  noise_std: 0.01
  dropout_rate: 0.1

# =============================================================================
# SCENARIO-SPECIFIC BEST PARAMS (for quick reference)
# =============================================================================
best_params:
  scenario1:
    lstm_hidden_dim: 64
    learning_rate: 0.001
    dropout: 0.2
  scenario2:
    lstm_hidden_dim: 64
    learning_rate: 0.0005
    dropout: 0.2

# =============================================================================
# ENSEMBLE SETTINGS
# =============================================================================
ensemble:
  include: false  # Only include if improves official_metric
  initial_weight: 0.1
  min_weight: 0.0
  max_weight: 0.3

# =============================================================================
# LOGGING
# =============================================================================
logging:
  level: INFO
  save_attention_weights: true

# =============================================================================
# REPRODUCIBILITY
# =============================================================================
seed: 42
